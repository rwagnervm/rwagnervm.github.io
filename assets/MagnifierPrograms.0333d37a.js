import{n as b}from"./WGLContainer.a2728de7.js";import{t as wt}from"./CircularArray.0c40a6a8.js";import{d as B,k as yt,a6 as x,a9 as E,aa as _,ab as g,ac as R,ad as ht,ae as Mt,af as _t,K as pt,N as bt,ag as xt,ah as gt,ai as Q,aj as K,ak as vt,al as j,am as Tt,an as $t,ao as nt,ap as St,aq as Ct,ar as Dt,as as Z,at as Vt,au as ot,av as zt,aw as Et,a2 as O,ax as lt}from"./index.7eb0daf2.js";import{t as Rt}from"./testSVGPremultipliedAlpha.3be788db.js";import{a as U,N as Lt,O as It}from"./definitions.a3a54ed1.js";import{t as At}from"./AttributeStore.38266bd6.js";import{a as Ft}from"./ProgramTemplate.7599c672.js";const se={shaders:{vertexShader:b("bitBlit/bitBlit.vert"),fragmentShader:b("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])},ne={shaders:{vertexShader:b("stencil/stencil.vert"),fragmentShader:b("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},oe={shaders:{vertexShader:b("highlight/textured.vert"),fragmentShader:b("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},ae={shaders:{vertexShader:b("highlight/textured.vert"),fragmentShader:b("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},w=B("esri-2d-profiler");class re{constructor(t,e){if(this._events=new yt,this._entries=new Map,this._timings=new wt(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,!w)return;this._ext=Rt(t.gl,{}),this._debugOutput=e;const i=t.gl;if(!this.enableCommandLogging)return;let n;for(n in i)if(typeof i[n]=="function"){const a=i[n],r=n.includes("draw");i[n]=(...h)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:n,args:h,isDrawCommand:r}),this._currentSummary&&(this._currentSummary.commands++,r&&this._currentSummary.drawCommands++),a.apply(i,h))}}get enableCommandLogging(){return!(typeof w=="object"&&w.disableCommands)}recordContainerStart(t){w&&(this._currentContainer=t)}recordContainerEnd(){w&&(this._currentContainer=null)}recordPassStart(t){w&&(this._currentPass=t,this._initSummary())}recordPassEnd(){w&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){w&&(this._currentBrush=t)}recordBrushEnd(){w&&(this._currentBrush=null)}recordStart(t){if(w&&this._ext!=null){if(this._entries.has(t)){const i=this._entries.get(t),n=this._ext.resultAvailable(i.query),a=this._ext.disjoint();if(n&&!a){const r=this._ext.getResult(i.query)/1e6;let h=0;if(this._timings.enqueue(r)!=null){const u=this._timings.entries,d=u.length;let c=0;for(const m of u)c+=m;h=c/d}const o=r.toFixed(2),l=h?h.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${o} ms (${l} last 10 avg)
${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${o} ms (${l} last 10 avg)`),this._debugOutput.innerHTML=`${o} (${l})`}for(const r of i.handles)r.remove();this._ext.deleteQuery(i.query),this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",i=>{e.commandsLen++,e.commands.push(i),i.isDrawCommand&&e.drawCommands++})),e.handles.push(this._events.on("summary",i=>{e.summaries.push(i)}))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){w&&this._ext!=null&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}}const y=1,H=0,k=1,N=2;class Pt{constructor(t,e,i){this._width=t*i,this._height=e*i,this._pixelRatio=i;const n=Math.ceil(this._width/y),a=Math.ceil(this._height/y);this._cols=n,this._rows=a,this._cells=At.create(n*a)}insertMetrics(t){this._markMetrics(t)}hasCollision(t){let e=0;for(const{computedX:i,computedY:n,width:a,height:r}of t.bounds){const h=(a+U)*this._pixelRatio,o=(r+U)*this._pixelRatio;switch(this._collide(i,n,h,o)){case N:return N;case k:e++}}return e===t.bounds.length?k:H}getCellId(t,e){return t+e*this._cols}has(t){return this._cells.has(t)}hasRange(t,e){return this._cells.hasRange(t,e)}set(t){this._cells.set(t)}setRange(t,e){this._cells.setRange(t,e)}_collide(t,e,i,n){const a=t-i/2,r=e-n/2,h=a+i,o=r+n;if(h<0||o<0||a>this._width||r>this._height)return k;const l=x(Math.floor(a/y),0,this._cols),u=x(Math.floor(r/y),0,this._rows),d=x(Math.ceil(h/y),0,this._cols),c=x(Math.ceil(o/y),0,this._rows);for(let m=u;m<=c;m++)for(let p=l;p<=d;p++){const v=this.getCellId(p,m);if(this.has(v))return N}return H}_mark(t,e,i,n,a){const r=t-i/2,h=e-n/2,o=r+i,l=h+n,u=x(Math.floor(r/y),0,this._cols),d=x(Math.floor(h/y),0,this._rows),c=x(Math.ceil(o/y),0,this._cols),m=x(Math.ceil(l/y),0,this._rows);for(let p=d;p<=m;p++)for(let v=u;v<=c;v++){const q=this.getCellId(v,p);this.set(q)}return!1}_markMetrics(t){for(const{computedX:e,computedY:i,width:n,height:a}of t.bounds){const r=(n+U)*this._pixelRatio,h=(a+U)*this._pixelRatio;this._mark(e,i,r,h,t.entityTexel)}}}const L=254,G=255,I=0;function C(s,t){const e=s.children.slice();e.sort((i,n)=>i.tileAge-n.tileAge),e.forEach(i=>{i.labelMetrics!=null&&i.isReady&&t(i,i.labelMetrics)})}function ut(s,t){return(!s.minScale||s.minScale>=t)&&(!s.maxScale||s.maxScale<=t)}class kt{run(t,e,i,n){const a=[];for(let r=t.length-1;r>=0;r--){const h=t[r];h.labelingCollisionInfos?.length&&a.push(...h.labelingCollisionInfos)}B("esri-2d-update-debug")&&a.length&&console.debug("CollisionEngine.run"),this._transformMetrics(a),this._runCollision(a,e,i,n);for(const r of a)r.container.requestRender()}_runCollision(t,e,i,n){const[a,r]=e.state.size,h=new Pt(a,r,e.pixelRatio);for(const{container:o,deconflictionEnabled:l,visible:u}of t){const d=o.attributeView;l?u?(this._prepare(o),this._collideVisible(h,o,i,n),this._collideInvisible(h,o)):C(o,(c,m)=>{for(const p of m)d.setLabelMinZoom(p.entityTexel,G)}):C(o,(c,m)=>{for(const p of m)ut(p,i)?(d.setLabelMinZoom(p.entityTexel,I),u&&h.insertMetrics(p)):d.setLabelMinZoom(p.entityTexel,L)})}}_isFiltered(t,e,i){const n=e.getFilterFlags(t),a=!i.hasFilter||!!(n&Lt),r=i.featureEffect==null||i.featureEffect.excludedLabelsVisible||!!(n&It);return!(a&&r)}_prepare(t){const e=t.attributeView,i=new Set;C(t,(n,a)=>{for(const r of a){const h=r.entityTexel;if(!i.has(h)){if(i.add(h),this._isFiltered(h,e,t.layerView)){e.setLabelMinZoom(h,L);continue}e.getLabelMinZoom(h)!==I?e.setLabelMinZoom(h,G):e.setLabelMinZoom(h,I)}}})}_collideVisible(t,e,i,n){const a=e.attributeView,r=new Set;C(e,(h,o)=>{for(let l=0;l<o.length;l++){const u=o[l].entityTexel;if(r.has(u))continue;if(h.key.level!==n){a.setLabelMinZoom(u,L),r.add(u);continue}if(!ut(o[l],i)){a.setLabelMinZoom(u,L),r.add(u);continue}if(a.getLabelMinZoom(u)!==0){r.add(u);continue}let d=!1,c=!0;const m=l;let p=l;for(;p<o.length;p++){const v=o[p];if(v.entityTexel!==u)break;if(!d)switch(t.hasCollision(v)){case k:break;case N:d=!0,c=!1;break;case H:c=!1}}if(!d)for(let v=m;v<p;v++)t.insertMetrics(o[v]);l=p-1,c||(r.add(u),a.setLabelMinZoom(u,d?L:I))}})}_collideInvisible(t,e){const i=e.attributeView,n=new Set;C(e,(a,r)=>{for(let h=0;h<r.length;h++){const o=r[h].entityTexel;if(n.has(o))continue;if(i.getLabelMinZoom(o)!==G){n.add(o);continue}let l=!1,u=!0;const d=h;let c=h;for(;c<r.length;c++){const m=r[c];if(m.entityTexel!==o)break;if(!l)switch(t.hasCollision(m)){case k:break;case N:l=!0,u=!1;break;case H:u=!1}}if(!l)for(let m=d;m<c;m++)t.insertMetrics(r[m]);h=c-1,u||(n.add(o),i.setLabelMinZoom(o,l?G:I))}})}_transformMetrics(t){for(const{container:e,geometryType:i,vvEvaluators:n}of t)C(e,(a,r)=>{const h=e.attributeView,o=a.transforms.labelMat2d;o[4]=Math.round(o[4]),o[5]=Math.round(o[5]);const l=i==="polyline";for(const u of r){const{entityTexel:d,anchorX:c,anchorY:m}=u;let p=u.referenceBounds?.size??0;const v=n[0];if(v!=null){const f=v(h.getVVSize(d));p=isNaN(f)||f==null||f===1/0?p:f}const q=u.directionX*(p/2),rt=u.directionY*(p/2);for(const f of u.bounds){let J=c,W=m;if(l){let $=J+f.x+q,S=W+f.y+rt;$=o[0]*$+o[2]*S+o[4],S=o[1]*$+o[3]*S+o[5],f.computedX=Math.floor($),f.computedY=Math.floor(S)}else{J=o[0]*c+o[2]*m+o[4],W=o[1]*c+o[3]*m+o[5];const $=J+f.x+q,S=W+f.y+rt;f.computedX=$,f.computedY=S}}}})}}const Nt=32;let A=class extends E{constructor(s){super(s),this._lastUpdate=0,this.collisionEngine=new kt,this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}get updating(){return B("esri-2d-log-updating")&&console.log(`Updating LabelManager ${this.updateRequested}:
-> updateRequested: ${this.updateRequested}`),this.updateRequested}update(s){const t=performance.now();t-this._lastUpdate>=Nt?(this._lastUpdate=t,this.doUpdate(s)):this.requestUpdate()}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view?.requestUpdate())}processUpdate(s){this.updateRequested&&(this.updateRequested=!1,this.update(s))}doUpdate(s){const t=this.view;if(t)try{const e=s.state.scale,i=t.featuresTilingScheme.getClosestInfoForScale(e).level;this.collisionEngine.run(t.allLayerViews.items,s,e,i)}catch{}}};_([g()],A.prototype,"updateRequested",void 0),_([g()],A.prototype,"updating",null),_([g()],A.prototype,"view",void 0),A=_([R("esri.views.2d.LabelManager")],A);const X="esri-zoom-box",Y={container:`${X}__container`,overlay:`${X}__overlay`,background:`${X}__overlay-background`,box:`${X}__outline`},tt={zoom:"Shift",counter:"Control"};let F=class extends E{constructor(s){super(s),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._rafId=null,this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(s){this.removeAllHandles(),this._destroyOverlay(),this._set("view",s),s&&this.addHandles([s.on("drag",[tt.zoom],t=>this._handleDrag(t,1),ht.INTERNAL),s.on("drag",[tt.zoom,tt.counter],t=>this._handleDrag(t,-1),ht.INTERNAL)])}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(s,t,e,i){this._box.x=s,this._box.y=t,this._box.width=e,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(s,t,e,i,n){const a=this.view,r=a.toMap(Mt(s+.5*e,t+.5*i));let h=Math.max(e/a.width,i/a.height);n===-1&&(h=1/h),this._destroyOverlay(),this.navigation.end(),a.goTo({center:r,scale:a.scale*h},{animationMode:"always",duration:_t(B("mapview-essential-goto-duration"))})}_updateBox(s,t,e,i){const n=this._boxShape;n.setAttributeNS(null,"x",""+s),n.setAttributeNS(null,"y",""+t),n.setAttributeNS(null,"width",""+e),n.setAttributeNS(null,"height",""+i),n.setAttributeNS(null,"class",Y.box)}_updateBackground(s,t,e,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(s,t,e,i,this.view.width,this.view.height))}_createContainer(){const s=document.createElement("div");s.className=Y.container,this.view.root.appendChild(s),this._container=s}_createOverlay(){const s=this.view.width,t=this.view.height,e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttributeNS(null,"d","M 0 0 L "+s+" 0 L "+s+" "+t+" L 0 "+t+" Z"),e.setAttributeNS(null,"class",Y.background);const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttributeNS(null,"class",Y.overlay),n.appendChild(e),n.appendChild(i),this._container.appendChild(n),this._backgroundShape=e,this._boxShape=i,this._overlay=n}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(s,t,e,i,n,a){const r=s+e,h=t+i;return"M 0 0 L "+n+" 0 L "+n+" "+a+" L 0 "+a+" ZM "+s+" "+t+" L "+s+" "+h+" L "+r+" "+h+" L "+r+" "+t+" Z"}_handleDrag(s,t){const e=s.x,i=s.y,n=s.origin.x,a=s.origin.y;let r,h,o,l;switch(e>n?(r=n,o=e-n):(r=e,o=n-e),i>a?(h=a,l=i-a):(h=i,l=a-i),s.action){case"start":this._start();break;case"update":this._update(r,h,o,l);break;case"end":this._end(r,h,o,l,t)}s.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:s,y:t,width:e,height:i}=this._box;this._updateBox(s,t,e,i),this._updateBackground(s,t,e,i),this._rafId=requestAnimationFrame(this._redraw)}};_([g()],F.prototype,"navigation",void 0),_([g()],F.prototype,"view",null),F=_([R("esri.views.2d.navigation.ZoomBox")],F);const Zt=F;class T{constructor(t){this._gain=t,this.lastValue=void 0,this.filteredDelta=void 0}update(t){if(this.hasLastValue()){const e=this.computeDelta(t);this._updateDelta(e)}this.lastValue=t}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return this.lastValue!==void 0}hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(t){return this.lastValue===void 0?NaN:t-this.lastValue}_updateDelta(t){this.filteredDelta!==void 0?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*t:this.filteredDelta=t}}class at{constructor(t,e,i){this._initialVelocity=t,this._stopVelocity=e,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(t){return t>this.duration}get friction(){return this._friction}value(t){return this.valueFromInitialVelocity(this._initialVelocity,t)}valueDelta(t,e){const i=this.value(t);return this.value(t+e)-i}valueFromInitialVelocity(t,e){e=Math.min(e,this.duration);const i=1-this.friction;return t*(i**e-1)/Math.log(i)}}class Bt extends at{constructor(t,e,i,n,a){super(t,e,i),this._sceneVelocity=n,this.direction=a}value(t){return super.valueFromInitialVelocity(this._sceneVelocity,t)}}class qt{constructor(t=300,e=12,i=.84){this._minimumInitialVelocity=t,this._stopVelocity=e,this._friction=i,this.enabled=!0,this._time=new T(.6),this._screen=[new T(.4),new T(.4)],this._scene=[new T(.6),new T(.6),new T(.6)],this._tmpDirection=pt()}add(t,e,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(t[0]),this._screen[1].update(t[1]),this._scene[0].update(e[0]),this._scene[1].update(e[1]),this._scene[2].update(e[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const t=this._screen[0].filteredDelta,e=this._screen[1].filteredDelta,i=t==null||e==null?0:Math.sqrt(t*t+e*e),n=this._time.filteredDelta,a=n==null||i==null?0:i/n;return Math.abs(a)<this._minimumInitialVelocity?null:this.createMomentum(a,this._stopVelocity,this._friction)}createMomentum(t,e,i){bt(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const n=xt(this._tmpDirection);n>0&&gt(this._tmpDirection,this._tmpDirection,1/n);const a=this._time.filteredDelta;return new Bt(t,e,i,a==null?0:n/a,this._tmpDirection)}}let V=class extends E{constructor(s){super(s),this.animationTime=0,this.momentumEstimator=new qt(500,6,.92),this.momentum=null,this.tmpMomentum=pt(),this.momentumFinished=!1,this.viewpoint=new Q({targetGeometry:new K,scale:0,rotation:0}),this._previousDrag=null,vt(()=>this.momentumFinished,()=>this.navigation.stop())}begin(s,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this._previousDrag=t}update(s,t){this.addToEstimator(t);let e=t.center.x,i=t.center.y;const n=this._previousDrag;e=n?n.center.x-e:-e,i=n?i-n.center.y:i,s.viewpoint=j(this.viewpoint,s.viewpoint,[e||0,i||0]),this._previousDrag=t}end(s,t){this.addToEstimator(t);const e=s.navigation.effectiveMomentumEnabled;this.momentum=e?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(s),this._previousDrag=null,this.navigation.end()}addToEstimator(s){const t=s.center.x,e=s.center.y,i=Tt(-t,e),n=$t(-t,e,0);this.momentumEstimator.add(i,n,.001*s.timestamp)}onAnimationUpdate(s){this.navigation.animationManager?.animateContinuous(s.viewpoint,(t,e)=>{const{momentum:i,animationTime:n,tmpMomentum:a}=this,r=.001*e;if(!(this.momentumFinished=!i||i.isFinished(n))){const h=i.valueDelta(n,r);gt(a,i.direction,h),j(t,t,a),s.constraints.constrainByGeometry(t)}this.animationTime+=r})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};_([g()],V.prototype,"momentumFinished",void 0),_([g()],V.prototype,"viewpoint",void 0),_([g()],V.prototype,"navigation",void 0),V=_([R("esri.views.2d.navigation.actions.Pan")],V);const Ot=V;class ft{constructor(t=2.5,e=.01,i=.95,n=12){this._minimumInitialVelocity=t,this._stopVelocity=e,this._friction=i,this._maxVelocity=n,this.enabled=!0,this.value=new T(.8),this.time=new T(.3)}add(t,e){if(this.enabled&&e!=null){if(this.time.hasLastValue()){if(this.time.computeDelta(e)<.01)return;if(this.value.hasFilteredDelta()){const i=this.value.computeDelta(t);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(e),this.value.update(t)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let t=this.value.filteredDelta/this.time.filteredDelta;return t=x(t,-this._maxVelocity,this._maxVelocity),Math.abs(t)<this._minimumInitialVelocity?null:this.createMomentum(t,this._stopVelocity,this._friction)}createMomentum(t,e,i){return new at(t,e,i)}}class Ut extends ft{constructor(t=3,e=.01,i=.95,n=12){super(t,e,i,n)}add(t,e){const i=this.value.lastValue;if(i!=null){let n=t-i;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;t=i+n}super.add(t,e)}}class Gt extends at{constructor(t,e,i){super(t,e,i)}value(t){const e=super.value(t);return Math.exp(e)}valueDelta(t,e){const i=super.value(t),n=super.value(t+e)-i;return Math.exp(n)}}class Xt extends ft{constructor(t=2.5,e=.01,i=.95,n=12){super(t,e,i,n)}add(t,e){super.add(Math.log(t),e)}createMomentum(t,e,i){return new Gt(t,e,i)}}let z=class extends E{constructor(s){super(s),this._animationTime=0,this._momentumFinished=!1,this._previousAngle=0,this._previousRadius=0,this._previousCenter=null,this._rotationMomentumEstimator=new Ut(.6,.15,.95),this._rotationDirection=1,this._startAngle=0,this._startRadius=0,this._updateTimestamp=null,this._zoomDirection=1,this._zoomMomentumEstimator=new Xt,this._zoomOnly=null,this.viewpoint=new Q({targetGeometry:new K,scale:0,rotation:0}),this.zoomMomentum=null,this.rotateMomentum=null,this.addHandles(vt(()=>this._momentumFinished,()=>this.navigation.stop()))}begin(s,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,s.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}update(s,t){this._updateTimestamp===null&&(this._updateTimestamp=t.timestamp);const e=t.angle,i=t.radius,n=t.center,a=Math.abs(180*(e-this._startAngle)/Math.PI),r=Math.abs(i-this._startRadius),h=this._startRadius/i;if(this._previousRadius&&this._previousCenter){const o=i/this._previousRadius;let l=180*(e-this._previousAngle)/Math.PI;this._rotationDirection=l>=0?1:-1,this._zoomDirection=o>=1?1:-1,s.constraints.rotationEnabled?(this._zoomOnly===null&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=r-a>0),this._zoomOnly===null||this._zoomOnly?l=0:this.addToRotateEstimator(e-this._startAngle,t.timestamp)):l=0,this.addToZoomEstimator(t,h),this.navigation.setViewpoint([n.x,n.y],1/o,l,[this._previousCenter.x-n.x,n.y-this._previousCenter.y])}this._previousAngle=e,this._previousRadius=i,this._previousCenter=n}end(s){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(s),this.navigation.end()}addToRotateEstimator(s,t){this._rotationMomentumEstimator.add(s,.001*t)}addToZoomEstimator(s,t){this._zoomMomentumEstimator.add(t,.001*s.timestamp)}canZoomIn(s){const t=s.scale,e=s.constraints.effectiveMaxScale;return e===0||t>e}canZoomOut(s){const t=s.scale,e=s.constraints.effectiveMinScale;return e===0||t<e}onAnimationUpdate(s){this.navigation.animationManager?.animateContinuous(s.viewpoint,(t,e)=>{const i=!this.canZoomIn(s)&&this._zoomDirection>1||!this.canZoomOut(s)&&this._zoomDirection<1,n=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),a=i||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),r=.001*e;if(this._momentumFinished=n&&a,!this._momentumFinished){const h=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,r))*this._rotationDirection*180/Math.PI:0;let o=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,r)):1;const l=Z(),u=Z();if(this._previousCenter){nt(l,this._previousCenter.x,this._previousCenter.y),St(u,s.size,s.padding),Ct(l,l,u);const{constraints:d,scale:c}=s,m=c*o;o<1&&!d.canZoomInTo(m)?(o=c/d.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):o>1&&!d.canZoomOutTo(m)&&(o=c/d.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),Dt(t,s.viewpoint,o,h,l,s.size),s.constraints.constrainByGeometry(t)}}this._animationTime+=r})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};_([g()],z.prototype,"_momentumFinished",void 0),_([g()],z.prototype,"viewpoint",void 0),_([g()],z.prototype,"navigation",void 0),z=_([R("esri.views.2d.navigation.actions.Pinch")],z);const Yt=z,et=Z(),mt=Z();let P=class extends E{constructor(s){super(s),this._previousCenter=Z(),this.viewpoint=new Q({targetGeometry:new K,scale:0,rotation:0})}begin(s,t){this.navigation.begin(),nt(this._previousCenter,t.center.x,t.center.y)}update(s,t){const{state:{size:e,padding:i}}=s;nt(et,t.center.x,t.center.y),Vt(mt,e,i),s.viewpoint=ot(this.viewpoint,s.state.paddedViewState.viewpoint,zt(mt,this._previousCenter,et)),Et(this._previousCenter,et)}end(){this.navigation.end()}};_([g()],P.prototype,"viewpoint",void 0),_([g()],P.prototype,"navigation",void 0),P=_([R("esri.views.2d.navigation.actions.Rotate")],P);const jt=P,D=10,ct=1,it=new Q({targetGeometry:new K}),st=[0,0],dt=250;let M=class extends E{constructor(s){super(s),this._endTimer=null,this._lastEventTimestamp=null,this.animationManager=null,this.interacting=!1}initialize(){this.pan=new Ot({navigation:this}),this.rotate=new jt({navigation:this}),this.pinch=new Yt({navigation:this}),this.zoomBox=new Zt({view:this.view,navigation:this})}destroy(){this.pan=O(this.pan),this.rotate=O(this.rotate),this.pinch=O(this.pinch),this.zoomBox=O(this.zoomBox),this.animationManager=null}begin(){this.stop(),this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(dt)}async zoom(s,t=this._getDefaultAnchor()){if(this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return s<1?this.zoomIn(t):this.zoomOut(t);this.setViewpoint(t,s,0,[0,0])}async zoomIn(s){const t=this.view,e=t.constraints.snapToNextScale(t.scale);return this._zoomToScale(e,s)}async zoomOut(s){const t=this.view,e=t.constraints.snapToPreviousScale(t.scale);return this._zoomToScale(e,s)}setViewpoint(s,t,e,i){this.begin(),this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,s,t,e,i),this.end()}setViewpointImmediate(s,t=0,e=[0,0],i=this._getDefaultAnchor()){this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,s,t,e)}continuousRotateClockwise(){const s=this.view.viewpoint;this.animationManager?.animateContinuous(s,t=>{ot(t,t,-ct)})}continuousRotateCounterclockwise(){const s=this.view.viewpoint;this.animationManager?.animateContinuous(s,t=>{ot(t,t,ct)})}resetRotation(){this.view.constraints.rotationEnabled&&(this.view.rotation=0)}continuousPanLeft(){this._continuousPan([-D,0])}continuousPanRight(){this._continuousPan([D,0])}continuousPanUp(){this._continuousPan([0,D])}continuousPanDown(){this._continuousPan([0,-D])}continuousPanVector({x:s,y:t}){this._continuousPan([s*D,t*D])}stop(){this.pan.stopMomentumNavigation(),this.animationManager?.stop(),this.end(),this._endTimer!==null&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(s){const t=this.view.viewpoint;this.animationManager?.animateContinuous(t,e=>{j(e,e,s),this.view.constraints.constrainByGeometry(e)})}_startTimer(s){return this._endTimer!==null||(this._endTimer=setTimeout(()=>{this._endTimer=null;const t=performance.now()-(this._lastEventTimestamp??0);t<dt?this._endTimer=this._startTimer(t):this._set("interacting",!1)},s)),this._endTimer}_getDefaultAnchor(){const{size:s,padding:{left:t,right:e,top:i,bottom:n}}=this.view;return st[0]=.5*(s[0]-e+t),st[1]=.5*(s[1]-n+i),st}async _zoomToScale(s,t=this._getDefaultAnchor()){const{view:e}=this,{constraints:i,scale:n,viewpoint:a,size:r,padding:h}=e,o=i.canZoomInTo(s),l=i.canZoomOutTo(s);if(!(s<n&&!o||s>n&&!l))return lt(it,a,s/n,0,t,r,h),i.constrainByGeometry(it),e.goTo(it,{animate:!0,animationMode:"always",duration:_t(B("mapview-essential-goto-duration")),pickClosestTarget:!1})}_scaleRotateTranslateViewpoint(s,t,e,i,n){const{view:a}=this,{size:r,padding:h,constraints:o,scale:l,viewpoint:u}=a,d=l*e,c=o.canZoomInTo(d),m=o.canZoomOutTo(d);return(e<1&&!c||e>1&&!m)&&(e=1),j(u,u,n),lt(s,u,e,i,t,r,h),o.constrainByGeometry(s)}};_([g()],M.prototype,"animationManager",void 0),_([g({type:Boolean,readOnly:!0})],M.prototype,"interacting",void 0),_([g()],M.prototype,"pan",void 0),_([g()],M.prototype,"pinch",void 0),_([g()],M.prototype,"rotate",void 0),_([g()],M.prototype,"view",void 0),_([g()],M.prototype,"zoomBox",void 0),M=_([R("esri.views.2d.navigation.MapViewNavigation")],M);const he=M,Ht={shaders:{vertexShader:b("magnifier/magnifier.vert"),fragmentShader:b("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function le(s){return Ft(s,Ht)}export{ae as a,le as b,Ht as c,A as d,se as e,re as n,ne as r,oe as t,he as y};
