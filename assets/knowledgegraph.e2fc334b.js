import{cL as I,$ as G,I as A,g6 as F,g7 as J,cR as L,bz as x,cK as M,fN as P,cQ as Q,dI as V}from"./index.7eb0daf2.js";import{a as W,b as c,r as l,a1 as C,m as b,G as w,aJ as j,P as O,N as T,U as v,W as U,E as k,X as D,w as z,v as H,aK as X,aL as K,aM as B}from"./arcadeUtils.154760f4.js";import{l as Y}from"./portalUtils.e6491796.js";import{p as Z,n as $}from"./project.aab65bc4.js";import{s as tt,m as nt,t as et,p as rt,c as at}from"./GraphQueryStreaming.04edabe4.js";import"./TimeOnly.5d28261e.js";import"./UnknownTimeZone.4756be49.js";import"./ImmutableArray.28227007.js";import"./number.fad7db53.js";import"./featureConversionUtils.c6dfa488.js";import"./OptimizedFeature.32c00f5f.js";import"./OptimizedFeatureSet.6fd3bcb1.js";import"./FieldsIndex.333d0734.js";let p=null;async function it(t){const n=A.geometryServiceUrl??"";if(!n){F()||await J();for(const e of t)e.container[e.indexer]=L(e.container[e.indexer],x.WGS84);return}const r=t.map(e=>e.container[e.indexer]),i=new Z({geometries:r,outSpatialReference:x.WGS84}),s=await $(n,i);for(let e=0;e<s.length;e++){const a=t[e];a.container[a.indexer]=s[e]}}async function E(t,n){const r=new M({portal:t,id:n});return await r.load(),p===null&&(p=await G(()=>import("./knowledgeGraphService.9a99595e.js").then(function(i){return i.k}),["assets/knowledgeGraphService.9a99595e.js","assets/index.7eb0daf2.js","assets/index.d3b4073e.css","assets/GraphQueryStreaming.04edabe4.js"])),await p.fetchKnowledgeGraph(r.url)}function S(t,n,r,i,s){if(t===null)return null;if(w(t)||k(t))return t;if(D(t)||D(t))return t.toJSDate();if(z(t))return t.toStorageFormat();if(H(t))return t.toStorageString();if(X(t)){const e={};for(const a of t.keys())e[a]=S(t.field(a),n,r,i,s),e[a]instanceof P&&s.push({container:e,indexer:a});return e}if(v(t)){const e=t.map(a=>S(a,n,r,i,s));for(let a=0;a<e.length;a++)e[a]instanceof P&&s.push({container:e,indexer:a});return e}return K(t)?t.spatialReference.isWGS84?t:t.spatialReference.isWebMercator&&n?Q(t):t:void 0}function ot(t,n){if(!t)return t;if(t.spatialReference.isWGS84&&n.spatialReference.isWebMercator)return V(t);if(t.spatialReference.equals(n.spatialReference))return t;throw new c(n,l.WrongSpatialReference,null)}function R(t,n){if(!t)return null;const r={};for(const i in t)r[i]=m(t[i],n);return r}function m(t,n){return t===null?null:v(t)?t.map(r=>m(r,n)):t instanceof nt?{graphTypeName:t.typeName,id:t.id,graphType:"entity",properties:R(t.properties,n)}:t instanceof et?{graphType:"object",properties:R(t.properties,n)}:t instanceof rt?{graphTypeName:t.typeName,id:t.id,graphType:"relationship",originId:t.originId??null,destinationId:t.destinationId??null,properties:R(t.properties,n)}:t instanceof at?{graphType:"path",path:t.path?t.path.map(r=>m(r,n)):null}:K(t)?ot(t,n):w(t)||k(t)||B(t)?t:null}function St(t){t.mode==="async"&&(t.functions.knowledgegraphbyportalitem=function(n,r){return t.standardFunctionAsync(n,r,(i,s,e)=>{if(W(e,2,2,n,r),e[0]===null)throw new c(n,l.PortalRequired,r);if(e[0]instanceof C){const d=b(e[1]);let f;return f=n.services?.portal?n.services.portal:I.getDefault(),E(Y(e[0],f),d)}if(w(e[0])===!1)throw new c(n,l.InvalidParameter,r);const a=b(e[0]);return E(n.services?.portal??I.getDefault(),a)})},t.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),t.functions.querygraph=function(n,r){return t.standardFunctionAsync(n,r,async(i,s,e)=>{W(e,2,4,n,r);const a=e[0];if(!j(a))throw new c(n,l.InvalidParameter,r);const d=e[1];if(!w(d))throw new c(n,l.InvalidParameter,r);p===null&&(p=await G(()=>import("./knowledgeGraphService.9a99595e.js").then(function(o){return o.k}),["assets/knowledgeGraphService.9a99595e.js","assets/index.7eb0daf2.js","assets/index.d3b4073e.css","assets/GraphQueryStreaming.04edabe4.js"]));let f=null;const h=O(e[2],null);if(!(h instanceof T||h===null))throw new c(n,l.InvalidParameter,r);if(h){let o=[];f=S(h,!0,!1,n,o),o=o.filter(u=>!u.container[u.indexer].spatialReference.isWGS84),o.length>0&&await it(o)}const _=new tt({openCypherQuery:d,bindParameters:f});(a?.serviceDefinition?.currentVersion??11.3)>11.2&&(_.outputSpatialReference=n.spatialReference);const N=(await p.executeQueryStreaming(a,_)).resultRowsStream.getReader(),y=[];try{for(;;){const{done:o,value:u}=await N.read();if(o)break;if(v(u))for(const g of u)y.push(m(g,n));else{const g=[];for(const q of u)g.push(m(u[q],n));y.push(g)}}}catch(o){throw o}return T.convertJsonToArcade(y,U(n),!1,!0)})},t.signatures.push({name:"querygraph",min:2,max:4}))}export{St as registerFunctions};
