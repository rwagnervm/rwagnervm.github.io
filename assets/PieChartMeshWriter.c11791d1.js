import{C as h}from"./enums.8929356b.js";import{bv as te,$ as ee,d as se,bS as ie,s as re,n as oe,u as y,a6 as kt,bJ as Z,aY as ne,w as ae,A as ce,y as ue}from"./index.7eb0daf2.js";import{aY as Pt,aZ as St,a_ as bt,aU as v,a$ as le,aC as At,b0 as zt,b1 as J,b2 as wt,b3 as he,b4 as pe,b5 as fe,aj as de,ak as xe,b6 as me,aA as ye,aB as _e,aO as F}from"./UpdateTracking2D.571bdffb.js";import{e as Nt,i as Bt,l as ge}from"./GeometryUtils.c6f9b045.js";import{c as K,h as rt,t as N,R as ke,B as Pe,z as Se,V as be,A as we}from"./definitions.a3a54ed1.js";import{a as ve,i as Te,c as Ee}from"./TurboLine.af583914.js";import{t as Me,f as $e,a as Ie,g as Dt}from"./LabelMetric.267a8b18.js";import{z as Yt}from"./utils.dbb84a38.js";import"./earcut.dc9d94eb.js";import{e as Ae}from"./OptimizedFeature.32c00f5f.js";import{t as q}from"./constants.344a1358.js";import{U as ot,e as nt,w as at,d as ct,i as Rt}from"./enums.abef80de.js";function ze(s,t,e,i,r,o,n){pt=0;const a=(i-e)*o,c=r&&r.length,l=c?(r[0]-e)*o:a;let u,f,p,d,x,m=Ft(t,e,i,0,l,o,!0);if(m&&m.next!==m.prev){if(c&&(m=Ye(t,e,i,r,m,o)),a>80*o){u=p=t[0+e*o],f=d=t[1+e*o];for(let _=o;_<l;_+=o){const P=t[_+e*o],b=t[_+1+e*o];u=Math.min(u,P),f=Math.min(f,b),p=Math.max(p,P),d=Math.max(d,b)}x=Math.max(p-u,d-f),x=x!==0?1/x:0}O(m,s,o,u,f,x,n,0)}}function Ft(s,t,e,i,r,o,n){let a;if(n===Oe(s,t,e,i,r,o)>0)for(let c=i;c<r;c+=o)a=vt(c+t*o,s[c+t*o],s[c+1+t*o],a);else for(let c=r-o;c>=i;c-=o)a=vt(c+t*o,s[c+t*o],s[c+1+t*o],a);return a&&$(a,a.next)&&(C(a),a=a.next),a}function L(s,t=s){if(!s)return s;let e,i=s;do if(e=!1,i.steiner||!$(i,i.next)&&k(i.prev,i,i.next)!==0)i=i.next;else{if(C(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function O(s,t,e,i,r,o,n,a){if(!s)return;!a&&o&&(s=Gt(s,i,r,o));let c=s;for(;s.prev!==s.next;){const l=s.prev,u=s.next;if(o?Be(s,i,r,o):Ne(s))t.push(l.index/e+n),t.push(s.index/e+n),t.push(u.index/e+n),C(s),s=u.next,c=u.next;else if((s=u)===c){a?a===1?O(s=We(s,t,e,n),t,e,i,r,o,n,2):a===2&&Ue(s,t,e,i,r,o,n):O(L(s),t,e,i,r,o,n,1);break}}}function Ne(s){const t=s.prev,e=s,i=s.next;if(k(t,e,i)>=0)return!1;let r=s.next.next;const o=r;let n=0;for(;r!==s.prev&&(n===0||r!==o);){if(n++,z(t.x,t.y,e.x,e.y,i.x,i.y,r.x,r.y)&&k(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Be(s,t,e,i){const r=s.prev,o=s,n=s.next;if(k(r,o,n)>=0)return!1;const a=r.x<o.x?r.x<n.x?r.x:n.x:o.x<n.x?o.x:n.x,c=r.y<o.y?r.y<n.y?r.y:n.y:o.y<n.y?o.y:n.y,l=r.x>o.x?r.x>n.x?r.x:n.x:o.x>n.x?o.x:n.x,u=r.y>o.y?r.y>n.y?r.y:n.y:o.y>n.y?o.y:n.y,f=lt(a,c,t,e,i),p=lt(l,u,t,e,i);let d=s.prevZ,x=s.nextZ;for(;d&&d.z>=f&&x&&x.z<=p;){if(d!==s.prev&&d!==s.next&&z(r.x,r.y,o.x,o.y,n.x,n.y,d.x,d.y)&&k(d.prev,d,d.next)>=0||(d=d.prevZ,x!==s.prev&&x!==s.next&&z(r.x,r.y,o.x,o.y,n.x,n.y,x.x,x.y)&&k(x.prev,x,x.next)>=0))return!1;x=x.nextZ}for(;d&&d.z>=f;){if(d!==s.prev&&d!==s.next&&z(r.x,r.y,o.x,o.y,n.x,n.y,d.x,d.y)&&k(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;x&&x.z<=p;){if(x!==s.prev&&x!==s.next&&z(r.x,r.y,o.x,o.y,n.x,n.y,x.x,x.y)&&k(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function vt(s,t,e,i){const r=B.create(s,t,e);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function C(s){s.next.prev=s.prev,s.prev.next=s.next,s.prevZ&&(s.prevZ.nextZ=s.nextZ),s.nextZ&&(s.nextZ.prevZ=s.prevZ)}function De(s){let t=s,e=s;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==s);return e}function Ye(s,t,e,i,r,o){const n=new Array;for(let a=0,c=i.length;a<c;a++){const l=Ft(s,t,e,i[a]*o,a<c-1?i[a+1]*o:e*o,o,!1);l===l.next&&(l.steiner=!0),n.push(De(l))}n.sort(Ce);for(const a of n)r=Re(a,r);return r}function Re(s,t){const e=Fe(s,t);if(!e)return t;const i=Ot(e,s);return L(i,i.next),L(e,e.next)}function Fe(s,t){let e=t;const i=s.x,r=s.y;let o,n=-1/0;do{if(r<=e.y&&r>=e.next.y&&e.next.y!==e.y){const p=e.x+(r-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(p<=i&&p>n){if(n=p,p===i){if(r===e.y)return e;if(r===e.next.y)return e.next}o=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!o)return null;if(i===n)return o.prev;const a=o,c=o.x,l=o.y;let u,f=1/0;for(e=o.next;e!==a;)i>=e.x&&e.x>=c&&i!==e.x&&z(r<l?i:n,r,c,l,r<l?n:i,r,e.x,e.y)&&(u=Math.abs(r-e.y)/(i-e.x),(u<f||u===f&&e.x>o.x)&&W(e,s)&&(o=e,f=u)),e=e.next;return o}function Gt(s,t,e,i){let r;for(;r!==s;r=r.next){if(r=r||s,r.z===null&&(r.z=lt(r.x,r.y,t,e,i)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,Gt(s,t,e,i);r.prevZ=r.prev,r.nextZ=r.next}return s.prevZ.nextZ=null,s.prevZ=null,Ge(s)}function Ge(s){let t,e=1;for(;;){let i,r=s;s=null,t=null;let o=0;for(;r;){o++,i=r;let n=0;for(;n<e&&i;n++)i=i.nextZ;let a=e;for(;n>0||a>0&&i;){let c;n===0?(c=i,i=i.nextZ,a--):a!==0&&i?r.z<=i.z?(c=r,r=r.nextZ,n--):(c=i,i=i.nextZ,a--):(c=r,r=r.nextZ,n--),t?t.nextZ=c:s=c,c.prevZ=t,t=c}r=i}if(t.nextZ=null,e*=2,o<2)return s}}function k(s,t,e){return(t.y-s.y)*(e.x-t.x)-(t.x-s.x)*(e.y-t.y)}function Lt(s,t,e,i){return!!($(s,t)&&$(e,i)||$(s,i)&&$(e,t))||k(s,t,e)>0!=k(s,t,i)>0&&k(e,i,s)>0!=k(e,i,t)>0}function Le(s,t){let e=s;do{if(e.index!==s.index&&e.next.index!==s.index&&e.index!==t.index&&e.next.index!==t.index&&Lt(e,e.next,s,t))return!0;e=e.next}while(e!==s);return!1}function Oe(s,t,e,i,r,o){let n=0;for(let a=i,c=r-o;a<r;a+=o)n+=(s[c+t*o]-s[a+t*o])*(s[a+1+t*o]+s[c+1+t*o]),c=a;return n}function z(s,t,e,i,r,o,n,a){return(r-n)*(t-a)-(s-n)*(o-a)>=0&&(s-n)*(i-a)-(e-n)*(t-a)>=0&&(e-n)*(o-a)-(r-n)*(i-a)>=0}function W(s,t){return k(s.prev,s,s.next)<0?k(s,t,s.next)>=0&&k(s,s.prev,t)>=0:k(s,t,s.prev)<0||k(s,s.next,t)<0}function lt(s,t,e,i,r){return(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=32767*(s-e)*r)|s<<8))|s<<4))|s<<2))|s<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function $(s,t){return s.x===t.x&&s.y===t.y}function Ce(s,t){return s.x-t.x}function We(s,t,e,i){let r=s;do{const o=r.prev,n=r.next.next;!$(o,n)&&Lt(o,r,r.next,n)&&W(o,n)&&W(n,o)&&(t.push(o.index/e+i),t.push(r.index/e+i),t.push(n.index/e+i),C(r),C(r.next),r=s=n),r=r.next}while(r!==s);return r}function Ue(s,t,e,i,r,o,n){let a=s;do{let c=a.next.next;for(;c!==a.prev;){if(a.index!==c.index&&He(a,c)){let l=Ot(a,c);return a=L(a,a.next),l=L(l,l.next),O(a,t,e,i,r,o,n,0),void O(l,t,e,i,r,o,n,0)}c=c.next}a=a.next}while(a!==s)}function He(s,t){return s.next.index!==t.index&&s.prev.index!==t.index&&!Le(s,t)&&W(s,t)&&W(t,s)&&Ve(s,t)}function Ve(s,t){let e=s,i=!1;const r=(s.x+t.x)/2,o=(s.y+t.y)/2;do e.y>o!=e.next.y>o&&e.next.y!==e.y&&r<(e.next.x-e.x)*(o-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==s);return i}function Ot(s,t){const e=B.create(s.index,s.x,s.y),i=B.create(t.index,t.x,t.y),r=s.next,o=t.prev;return s.next=t,t.prev=s,e.next=r,r.prev=e,i.next=e,e.prev=i,o.next=i,i.prev=o,i}class B{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const r=pt<ht.length?ht[pt++]:new B;return r.index=t,r.x=e,r.y=i,r.prev=null,r.next=null,r.z=null,r.prevZ=null,r.nextZ=null,r.steiner=!1,r}}const ht=[],Xe=8096;let pt=0;for(let s=0;s<Xe;s++)ht.push(new B);const Ze=1e-5,M=new Nt(0,0,0,1,0),ft=new Nt(0,0,0,1,0);function Tt(s,t,e){let i=0;for(let r=1;r<e;r++){const o=s[2*(t+r-1)],n=s[2*(t+r-1)+1];i+=(s[2*(t+r)]-o)*(s[2*(t+r)+1]+n)}return i}function qe(s,t,e,i,r){let o=0;const n=2;for(let a=e;a<i;a+=3){const c=(s[a]-r)*n,l=(s[a+1]-r)*n,u=(s[a+2]-r)*n;o+=Math.abs((t[c]-t[u])*(t[l+1]-t[c+1])-(t[c]-t[l])*(t[u+1]-t[c+1]))}return o}function Qe(s,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:r}=t,o=0,n=s;if(r)return!1;let a=0;for(let c=0;c<i.length;){let l=c,u=i[c],f=Tt(e,a,u);const p=[];for(;++l<i.length;){const _=i[l],P=Tt(e,a+u,_);if(!(P>0))break;f+=P,p.push(a+u),u+=_}const d=n.length;ze(n,e,a,a+u,p,2,o);const x=qe(n,e,d,n.length,o),m=Math.abs(f);if(Math.abs((x-m)/Math.max(1e-7,m))>Ze)return n.length=0,!1;c=l,a+=u}return!0}function je(s){const{coords:t,lengths:e}=s,{buffer:i}=ve(t,e);return i}function Je(s,t,e){let i=0;for(let r=0;r<s.lengths.length;r++){const o=s.lengths[r];for(let n=0;n<o;n++){const a=s.coords[2*(n+i)],c=s.coords[2*(n+i)+1];if(a<t||a>e||c<t||c>e)return!0}i+=o}return!1}function Ct(s,t){if(s==null)return null;if(!Je(s,-128,K+128))return s;M.setPixelMargin(t),M.reset(Bt.Polygon);let e=0;for(let n=0;n<s.lengths.length;n++){const a=s.lengths[n];let c=s.coords[2*(0+e)],l=s.coords[2*(0+e)+1];M.moveTo(c,l);for(let u=1;u<a;u++)c=s.coords[2*(u+e)],l=s.coords[2*(u+e)+1],M.lineTo(c,l);M.close(),e+=a}const i=M.result(!1);if(!i)return null;const r=[],o=[];for(const n of i){let a=0;for(const c of n)o.push(c.x),o.push(c.y),a++;r.push(a)}return new Ae(r,o)}function Ke(s,t){ft.setPixelMargin(t);const e=ft,i=-t,r=K+t;let o=[],n=!1;if(!s.nextPath())return null;let a=!0;for(;a;){s.seekPathStart();const c=[];if(!s.pathSize)return null;e.reset(Bt.LineString),s.nextPoint();let l=s.x,u=s.y;if(n)e.moveTo(l,u);else{if(l<i||l>r||u<i||u>r){n=!0;continue}c.push({x:l,y:u})}let f=!1;for(;s.nextPoint();)if(l=s.x,u=s.y,n)e.lineTo(l,u);else{if(l<i||l>r||u<i||u>r){f=!0;break}c.push({x:l,y:u})}if(f)n=!0;else{if(n){const p=e.resultWithStarts();if(p)for(const d of p)o.push(d)}else o.push({line:c,start:0});a=s.nextPath(),n=!1}}return o=o.filter(c=>c.line.length>1),o.length===0?null:o}M.setExtent(K),ft.setExtent(K);const ts=96/72;class es{static executeEffects(t,e,i,r){const o=ts,n=Pt(t);let a=new bt(e);for(const c of t){const l=St(c);l&&(a=l.execute(a,c,o,i,r,n))}return a}static applyEffects(t,e,i){if(!t)return e;const r=Pt(t);let o,n=new bt(v.fromJSONCIM(e));for(const l of t){const u=St(l);u&&(n=u.execute(n,l,1,null,i,r))}const a=[];let c=null;for(;o=n.next();)a.push(...te(o)),c=o.geometryType;return a.length===0||c===null?null:c==="esriGeometryPolygon"?{rings:a}:{paths:a}}}let Wt=null;function xt(){return Wt}async function ss(){Wt=await ee(()=>import("./geometryEngineJSON.01a4d20d.js"),["assets/geometryEngineJSON.01a4d20d.js","assets/geometryEngineBase.99ab4263.js","assets/index.7eb0daf2.js","assets/index.d3b4073e.css","assets/geometryEngineJSON.ca151196.js","assets/json.20588c22.js"])}function Ut(s){switch(s){case h.BYTE:case h.UNSIGNED_BYTE:return 1;case h.SHORT:case h.UNSIGNED_SHORT:case h.HALF_FLOAT:return 2;case h.FLOAT:case h.INT:case h.UNSIGNED_INT:return 4}}function is(s){const t=[],e=[],i=[];for(const r of s){const o=Ut(r.type)*r.count;switch(o%2||o%4||4){case 4:t.push(r);continue;case 2:e.push(r);continue;case 1:i.push(r);continue;default:throw new Error("Found unexpected dataType byte count")}}return t.push(...e),t.push(...i),t}class mt{static fromVertexSpec(t,e){const{attributes:i,optionalAttributes:r}=t;let o,n,a;const c=[];for(const m in i){const _=i[m];_.pack==="position"?o={..._,name:m,offset:0}:_.pack==="id"?n={..._,name:m,offset:4}:m==="bitset"?a={..._,name:m,offset:7}:c.push({..._,name:m})}for(const m in r)if(e[m]===!0){const _=r[m];c.push({..._,name:m})}const l=is(c),u=[];let f=8,p=1;for(const m of l)u.push({...m,offset:f}),f+=Ut(m.type)*m.count,m.packAlternating&&(p=Math.max(m.packAlternating.count,p));const d=Uint32Array.BYTES_PER_ELEMENT,x=f%d;return new mt(o,n,a,u,f+(x?d-x:0),p)}constructor(t,e,i,r,o,n){this.position=t,this.id=e,this.bitset=i,this.standardAttributes=r,this.stride=o,this.packVertexCount=n,r.push(i),this._attributes=[t,e,i,...r]}get attributeLayout(){if(!this._attributeLayout){const t=Me(this._attributes),e=this._attributes.map(i=>({name:i.name,count:i.count,offset:i.offset,type:i.type,packPrecisionFactor:i.packPrecisionFactor,normalized:i.normalized??!1}));this._attributeLayout={attributes:e,hash:t,stride:this.stride}}return this._attributeLayout}}class yt{static fromVertexSpec(t,e){const i=mt.fromVertexSpec(t,e);return new yt(i)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,e,i,r,o,n){for(let a=0;a<this._spec.packVertexCount;a++){const c=a*this._spec.stride;this._packPosition(i,r,c),this._packId(e,c);const l=this._spec.bitset;if(n){if(l.packTessellation){const u=l.packTessellation(n,o);this._pack(u,l,c)}for(const u of this._spec.standardAttributes)if(u.packTessellation!=null){const f=u.packTessellation(n,o);this._pack(f,u,c)}else if(u.packAlternating?.packTessellation){const f=u.packAlternating.packTessellation(n,o);for(let p=0;p<this._spec.packVertexCount;p++){const d=f[p];this._pack(d,u,p*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,e){for(const i of this._spec.standardAttributes)if(i.pack&&typeof i.pack!="string"){const r=i.pack(t,e);for(let o=0;o<this._spec.packVertexCount;o++)this._pack(r,i,o*this._spec.stride)}else if(i.packAlternating?.pack){const r=i.packAlternating.pack(t,e);for(let o=0;o<this._spec.packVertexCount;o++){const n=r[o];this._pack(n,i,o*this._spec.stride)}}}_packPosition(t,e,i){const{offset:r}=this._spec.position,o=this._spec.position.packPrecisionFactor??1,n=Ie(t*o,e*o);this._dataView.setUint32(i+r,n,!0)}_packId(t,e){const i=t*(this._spec.id.packPrecisionFactor??1),r=4278190080&this._dataView.getUint32(e+this._spec.id.offset,!0);this._dataView.setUint32(e+this._spec.id.offset,i|r,!0)}_pack(t,e,i){$e(this._dataView,t,e,i)}}function rs(s){if(!s)return!1;for(const t of s)switch(t.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1}class D{constructor(t,e,i,r){this._instanceId=t,this._evaluator=e,this._enabledOptionalAttributes=i,this._viewParams=r,this._evaluator.evaluator=o=>this.vertexSpec.createComputedParams(o)}get _vertexPack(){if(!this._cachedVertexPack){const t=yt.fromVertexSpec(this.vertexSpec,this._enabledOptionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){rs(this._evaluator.inputMeshParams.effects?.effectInfos)&&await ss()}enqueueRequest(t,e,i){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,e,i)}write(t,e,i,r,o){this.ensurePacked(e,i,r);const n=this.evaluatedMeshParams.effects;if(!n||n.length===0)return void this._write(t,i,void 0,o);const a=i.readGeometryForDisplay()?.clone();if(!a)return;const c=v.fromOptimizedCIM(a,i.geometryType),l=xt();c.invertY();const u=t.id||"",f=es.executeEffects(n,c,u,l);let p;for(;p=f.next();)p.invertY(),this._write(t,i,p,o)}ensurePacked(t,e,i){if(!this._evaluator.hasDynamicProperties)return;const r=this._evaluator.evaluateMeshParams(t,e,i);this._vertexPack.pack(r,this._viewParams)}_writeVertex(t,e,i,r,o){const n=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,e,i,r,n,o)}}const os=100,ns=se("featurelayer-fast-triangulation-enabled");class Ht extends D{async loadDependencies(){await Promise.all([super.loadDependencies(),Te()])}_write(t,e,i){const r=i?.asOptimized()??e.readGeometryForDisplay(),o=this._clip(r);o&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,o),t.recordEnd())}_clip(t){if(!t)return null;const e=this.hasEffects;return Ct(t,e?256:8)}_writeGeometry(t,e,i){const r=i.maxLength>os,o=[],n=this.createTesselationParams(e);if(!r&&ns&&Qe(o,i))return void(o.length&&this._writeVertices(t,e,i.coords,n,o));const a=je(i);this._writeVertices(t,e,a,n)}_writeVertices(t,e,i,r,o){const n=e.getDisplayId(),a=t.vertexCount(),c=this.hasEffects;let l=0;if(o)for(const u of o){const f=i[2*u],p=i[2*u+1];c&&t.recordBounds(f,p,0,0),this._writeVertex(t,n,f,p,r),l++}else for(let u=0;u<i.length;u+=2){const f=Math.round(i[u]),p=Math.round(i[u+1]);c&&t.recordBounds(f,p,0,0),this._writeVertex(t,n,f,p,r),l++}t.indexEnsureSize(l);for(let u=0;u<l;u++)t.indexWrite(u+a)}}const as={createComputedParams:s=>s,optionalAttributes:{},attributes:{id:{type:h.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:h.UNSIGNED_BYTE,count:1},pos:{type:h.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:h.FLOAT,count:1,packTessellation:({inverseArea:s})=>s}}};class Ks extends Ht{constructor(){super(...arguments),this.vertexSpec=as}createTesselationParams(t){return{inverseArea:1/t.readGeometryArea()}}}const cs=()=>oe.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils"),us=0,ls=100;function U(s,t){return[!!s?.minScale&&t.scaleToZoom(s.minScale)||us,!!s?.maxScale&&t.scaleToZoom(s.maxScale)||ls]}function G(s){return 1<<s}function H(s){let t=0;for(const[e,i]of s)i&&(t|=1<<e);return t}function g(s){let t;if(!s)return[0,0,0,0];if(typeof s=="string"){const n=ie.fromString(s);if(!n)return cs().errorOnce(new re("mapview:mesh-processing","Unable to parse string into color",{color:s})),[0,0,0,0];t=n.toArray()}else t=s;const[e,i,r,o]=t;return[e*(o/255),i*(o/255),r*(o/255),o]}function hs(s){switch(s){case"butt":case ot.Butt:return nt.BUTT;case"round":case ot.Round:return nt.ROUND;case"square":case ot.Square:return nt.SQUARE}}function ps(s){switch(s){case"bevel":case at.Bevel:return ct.BEVEL;case"miter":case at.Miter:return ct.MITER;case"round":case at.Round:return ct.ROUND}}function ut(s,t){return Math.round(Math.min(Math.sqrt(s*t),255))}function Q(s,t){return Math.round(s*t)/t}const dt={createComputedParams:s=>s,optionalAttributes:{zoomRange:{type:h.SHORT,count:2,packPrecisionFactor:rt,pack:({scaleInfo:s},{tileInfo:t})=>U(s,t)}},attributes:{id:{type:h.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:h.UNSIGNED_BYTE,count:1},pos:{type:h.SHORT,count:2,pack:"position",packPrecisionFactor:10},color:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:s})=>g(s)}}};class Vt extends Ht{constructor(){super(...arguments),this.vertexSpec=dt}createTesselationParams(t){return null}}const I={createComputedParams:s=>s,optionalAttributes:dt.optionalAttributes,attributes:{...dt.attributes,tlbr:{count:4,type:h.UNSIGNED_SHORT,pack:({sprite:s})=>{const{rect:t,width:e,height:i}=s,r=t.x+N,o=t.y+N;return[r,o,r+e,o+i]}},inverseRasterizationScale:{count:1,type:h.BYTE,packPrecisionFactor:16,pack:({sprite:s})=>1/s.rasterizationScale}}};class fs extends Vt{constructor(){super(...arguments),this.vertexSpec=I}_write(t,e,i){const r=i?.asOptimized()??e.readGeometryForDisplay(),o=this._clip(r);if(!o)return;const n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,e,o),t.recordEnd()}}function tt(s){const{sprite:t,aspectRatio:e,scaleProportionally:i}=s,r=y(s.height),o=r>0?r:t.height;let n=r*e;return n<=0?n=t.width:i&&(n*=t.width/t.height),{width:n,height:o}}function Xt(s){const{applyRandomOffset:t,sampleAlphaOnly:e}=s;return H([[le,t],[At,e]])}const Zt={createComputedParams:s=>s,optionalAttributes:I.optionalAttributes,attributes:{...I.attributes,bitset:{count:1,type:h.UNSIGNED_BYTE,pack:Xt},width:{count:1,type:h.HALF_FLOAT,pack:s=>tt(s).width},height:{count:1,type:h.HALF_FLOAT,pack:s=>tt(s).height},offset:{count:2,type:h.HALF_FLOAT,pack:({offsetX:s,offsetY:t})=>[y(s),-y(t)]},scale:{count:2,type:h.UNSIGNED_BYTE,packPrecisionFactor:16,pack:({scaleX:s,scaleY:t})=>[s,t]},angle:{count:1,type:h.UNSIGNED_BYTE,pack:({angle:s})=>ge(s)}}};class ti extends fs{constructor(){super(...arguments),this.vertexSpec=Zt}}class ds{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}}const A={createComputedParams:s=>s,optionalAttributes:{zoomRange:{type:h.SHORT,count:2,packPrecisionFactor:rt,pack:({scaleInfo:s},{tileInfo:t})=>U(s,t)}},attributes:{id:{type:h.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:h.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:h.UNSIGNED_BYTE,count:1},color:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:s})=>g(s)},offset:{type:h.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:s,extrusionOffsetY:t})=>[Q(s,16),Q(t,16)]},normal:{type:h.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:s,normalY:t})=>[Q(s,16),Q(t,16)]},halfWidth:{type:h.HALF_FLOAT,count:1,pack:({width:s})=>y(.5*s)},referenceHalfWidth:{type:h.HALF_FLOAT,count:1,pack:({referenceWidth:s})=>y(.5*s)}}};class xs{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}}const Et=65535;class qt extends D{constructor(t,e,i,r){super(t,e,i,r),this.vertexSpec=A,this._currentWrite=new xs,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:Et,textured:!1},this._tessParams=new ds,this._initializeTessellator()}writeLineVertices(t,e,i){const r=this._getLines(e);r!=null&&this._writeVertices(t,i,r)}_initializeTessellator(){this._lineTessellator=new Ee(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,e,i){const r=i??v.fromFeatureSetReaderCIM(e);r&&this._writeGeometry(t,e,r)}_writeGeometry(t,e,i,r){t.recordStart(this.instanceId,this.attributeLayout,r),this.writeLineVertices(t,i,e),t.recordEnd()}_getLines(t){return Ke(t,Dt(this.evaluatedMeshParams))}_writeVertices(t,e,i){const{_currentWrite:r,_tessellationOptions:o,evaluatedMeshParams:n}=this,{width:a,capType:c,joinType:l,miterLimit:u,hasSizeVV:f}=n,p=y(.5*a);o.halfWidth=p,o.capType=hs(c),o.joinType=ps(l),o.miterLimit=u;const d=!f;r.out=t,r.id=e.getDisplayId(),r.vertexCount=0,r.indexCount=0,r.vertexFrom=t.vertexCount(),r.vertexBounds=d&&p<ke?0:1;for(const{line:x,start:m}of i)o.initialDistance=m%Et,this._lineTessellator.tessellate(x,o,d)}_writeTesselatedVertex(t,e,i,r,o,n,a,c,l,u,f){const{out:p,id:d,vertexBounds:x}=this._currentWrite;return this.hasEffects&&p.recordBounds(t,e,x,x),this._tessParams.extrusionOffsetX=a,this._tessParams.extrusionOffsetY=c,this._tessParams.normalX=l,this._tessParams.normalY=u,this._tessParams.directionX=o,this._tessParams.directionY=n,this._tessParams.distance=f,this._writeVertex(p,d,t,e,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,e,i){const{out:r}=this._currentWrite;r.indexEnsureSize(3),r.indexWrite(t),r.indexWrite(e),r.indexWrite(i),this._currentWrite.indexCount+=3}}const Qt={createComputedParams:s=>s,optionalAttributes:A.optionalAttributes,attributes:{...A.attributes,bitset:{type:h.UNSIGNED_BYTE,count:1,pack:s=>0},color:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:s})=>g(s)}}},_t={createComputedParams:s=>s,optionalAttributes:A.optionalAttributes,attributes:{...A.attributes,bitset:{type:h.UNSIGNED_BYTE,count:1,pack:s=>H([[zt,!0]])},color:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:s})=>g(s)}}};class gt extends qt{constructor(){super(...arguments),this.vertexSpec=_t}}class jt extends Vt{constructor(t,e,i,r){super(t,e,i,r),this.vertexSpec=Qt,this._lineMeshWriter=this._createOutlineWriter(t,e,i,r)}_createOutlineWriter(t,e,i,r){return new gt(t,e,i,r)}_write(t,e,i){const r=i?.asOptimized()??e.readGeometryForDisplay(),o=this._clip(r);o&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,o),this._lineMeshWriter.writeLineVertices(t,v.fromOptimizedCIM(o,"esriGeometryPolyline"),e),t.recordEnd())}_clip(t){return t?Ct(t,Dt(this.evaluatedMeshParams)):null}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const et=Zt,ms=_t,ys={createComputedParams:s=>s,optionalAttributes:et.optionalAttributes,attributes:{...et.attributes,bitset:{type:h.UNSIGNED_BYTE,count:1,pack:s=>Xt(s)},aux1:{count:1,type:h.HALF_FLOAT,pack:s=>tt(s).width},aux2:{count:1,type:h.HALF_FLOAT,pack:s=>tt(s).height},aux3:{count:2,type:h.HALF_FLOAT,pack:({offsetX:s,offsetY:t})=>[y(s),y(t)]},aux4:{count:2,type:h.UNSIGNED_BYTE,pack:({scaleX:s,scaleY:t})=>[s*J,t*J]}}},_s={createComputedParams:s=>s,optionalAttributes:et.optionalAttributes,attributes:{...et.attributes,color:ms.attributes.color,bitset:{type:h.UNSIGNED_BYTE,count:1,pack:s=>H([[zt,!0]])},aux1:{count:1,type:h.HALF_FLOAT,pack:s=>y(.5*s.width)},aux2:{count:1,type:h.HALF_FLOAT,pack:s=>y(.5*s.referenceWidth)},aux3:{count:2,type:h.HALF_FLOAT,packTessellation:({extrusionOffsetX:s,extrusionOffsetY:t})=>[s,t]},aux4:{count:2,type:h.UNSIGNED_BYTE,packTessellation:({normalX:s,normalY:t})=>[s*J+wt,t*J+wt]}}};class gs extends gt{constructor(){super(...arguments),this.vertexSpec=_s}}class ei extends jt{constructor(){super(...arguments),this.vertexSpec=ys}_createOutlineWriter(t,e,i,r){return new gs(t,e,i,r)}_write(t,e,i){const r=i?.asOptimized()??e.readGeometryForDisplay(),o=this._clip(r);if(!o)return;const n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,e,o),this._lineMeshWriter.writeLineVertices(t,v.fromOptimizedCIM(o,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const ks={optionalAttributes:I.optionalAttributes,createComputedParams:s=>s,attributes:{...I.attributes,...Qt.attributes}},Ps={optionalAttributes:I.optionalAttributes,createComputedParams:s=>s,attributes:{...I.attributes,..._t.attributes}};class Ss extends gt{constructor(){super(...arguments),this.vertexSpec=Ps}}class si extends jt{constructor(){super(...arguments),this.vertexSpec=ks}_createOutlineWriter(t,e,i,r){return new Ss(t,e,i,r)}_write(t,e,i){const r=i?.asOptimized()??e.readGeometryForDisplay(),o=this._clip(r);if(!o)return;const n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,e,o),this._lineMeshWriter.writeLineVertices(t,v.fromOptimizedCIM(o,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const bs={createComputedParams:s=>s,optionalAttributes:{},attributes:{pos:{type:h.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:h.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:h.UNSIGNED_BYTE,count:1},offset:{type:h.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}};class ii extends D{constructor(){super(...arguments),this.vertexSpec=bs}_write(t,e){t.recordStart(this.instanceId,this.attributeLayout);const i=e.getDisplayId();if(e.geometryType==="esriGeometryPoint"){const r=e.readXForDisplay(),o=e.readYForDisplay();this._writeQuad(t,i,r,o)}else e.geometryType==="esriGeometryMultipoint"&&e.readGeometryForDisplay()?.forEachVertex((o,n)=>{o>=0&&o<=512&&n>=0&&n<=512&&this._writeQuad(t,i,o,n)});t.recordEnd()}_writeQuad(t,e,i,r){const o=t.vertexCount();this._writeVertex(t,e,i,r),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}}class Jt{static getPlacement(t,e,i,r,o,n){const a=he(i);return a?(e===-1&&t.invertY(),a.execute(t,i,r,o,n)):null}}const Mt=96;class ws{constructor(t){const{offsetX:e,offsetY:i,postAngle:r,fontSize:o,scaleFactor:n,transforms:a}=t;if(this.offsetX=e,this.offsetY=i,this.postAngle=r,this.fontSize=Math.min(o,Mt),this.transforms=a,a&&a.infos.length>1){const c=Yt(o,r,!1,e,i,a);this.fontSize=Math.min(c.size,Mt),this.postAngle=c.rotation,this.offsetX=c.offsetX,this.offsetY=c.offsetY}n&&(this.fontSize*=n,this.offsetX*=n,this.offsetY*=n)}}const vs=28,E=[4,4],j=[16,4],Ts={topLeft:j,topRight:j,bottomLeft:j,bottomRight:j},st=[4,2],S=[4,6],$t={topLeft:st,topRight:st,bottomLeft:S,bottomRight:S},It={topLeft:st,topRight:S,bottomLeft:st,bottomRight:S},Es={topLeft:S,topRight:S,bottomLeft:E,bottomRight:E},Ms={topLeft:E,topRight:E,bottomLeft:S,bottomRight:S},$s={topLeft:S,topRight:E,bottomLeft:S,bottomRight:E},Is={topLeft:E,topRight:S,bottomLeft:E,bottomRight:S},As={createComputedParams:s=>s,optionalAttributes:{zoomRange:{type:h.UNSIGNED_SHORT,count:2,packPrecisionFactor:rt,packTessellation:({minZoom:s,maxZoom:t})=>[s||0,t||vs]},clipAngle:{type:h.UNSIGNED_BYTE,count:1,packTessellation:({clipAngle:s})=>zs(s||0)},referenceSymbol:{type:h.BYTE,count:4,packPrecisionFactor:1,packTessellation:(s,t)=>{if(!s.referenceBounds)return[0,0,0,0];const e=pe(t.horizontalAlignment),i=fe(t.verticalAlignment),{offsetX:r,offsetY:o,size:n}=s.referenceBounds;return[y(r),-y(o),y(n),e+1<<2|i+1]}}},attributes:{pos:{type:h.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:h.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:h.UNSIGNED_BYTE,count:1,packTessellation:({isBackground:s,mapAligned:t})=>H([[de,s],[xe,!!t]])},offset:{type:h.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:({offsets:s})=>{const{bottomLeft:t,bottomRight:e,topLeft:i,topRight:r}=s;return[i,r,t,e]}}},textureUV:{type:h.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:({texcoords:s})=>{const{bottomLeft:t,bottomRight:e,topLeft:i,topRight:r}=s;return[i,r,t,e]}}},color:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:({color:s})=>s},fontSize:{type:h.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:({fontSize:s})=>y(s)},referenceSize:{type:h.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:({fontSize:s},{referenceSize:t})=>y(t??s)},haloColor:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,pack:({haloColor:s})=>g(s)},haloFontSize:{type:h.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,pack:({haloFontSize:s})=>y(s)}}};class ri extends D{constructor(){super(...arguments),this.vertexSpec=As,this._textMeshParamsPropsInitialized=!1}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new ws(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(t,e,i){const r=this._getShaping();if(!r)return;const o=e.getDisplayId();if(this.evaluatedMeshParams.placement!=null)return this._writePlacedTextMarkers(t,e,r,i);if(i?.nextPath())return i.nextPoint(),this._writeGlyphs(t,o,i.x,i.y,r,0);if(e.geometryType==="esriGeometryPolygon"){const c=e.readCentroidForDisplay();if(!c)return;const[l,u]=c.coords;return this._writeGlyphs(t,o,l,u,r,0)}if(e.geometryType==="esriGeometryMultipoint")return void e.readGeometryForDisplay()?.forEachVertex((l,u)=>this._writeGlyphs(t,o,l,u,r,0));const n=e.readXForDisplay(),a=e.readYForDisplay();return this._writeGlyphs(t,o,n,a,r,0)}_writePlacedTextMarkers(t,e,i,r){const o=r??v.fromFeatureSetReaderCIM(e);if(!o)return;const n=-1,a=Jt.getPlacement(o,n,this.evaluatedMeshParams.placement,y(1),t.id,xt());if(!a)return;const c=e.getDisplayId();let l=a.next();for(;l!=null;){const u=l.tx,f=-l.ty,p=-l.getAngle();this._writeGlyphs(t,c,u,f,i,p),l=a.next()}}_getShaping(t){const e=this._textMeshTransformProps,i=this.evaluatedMeshParams;if(!i.glyphs?.glyphs.length)return null;const r=Math.round(y(e.fontSize)),o=y(e.offsetX),n=y(e.offsetY),a=kt(y(i.lineWidth),Se,Pe),c=be*kt(i.lineHeightRatio,.25,4);return me(i.glyphs,{scale:r/we,angle:e.postAngle,xOffset:o,yOffset:n,horizontalAlignment:i.horizontalAlignment,verticalAlignment:t||i.verticalAlignment,maxLineWidth:a,lineHeight:c,decoration:i.decoration,borderLineSizePx:y(i.boxBorderLineSize),hasBackground:!!i.boxBackgroundColor,useCIMAngleBehavior:i.useCIMAngleBehavior})}_writeGlyphs(t,e,i,r,o,n,a,c){const l=this.evaluatedMeshParams,u=this._textMeshTransformProps,f=u.fontSize,p=y(u.offsetX),d=y(u.offsetY),[x,m]=U(l.scaleInfo,this.getTileInfo());n!==0&&o.setRotation(n);const _=o.bounds,P=i+_.x+p,b=r+_.y-d,Y=2*(l.minPixelBuffer?l.minPixelBuffer/f:1),w=Math.max(_.width,_.height)*Y;o.textBox&&(t.recordStart(this.instanceId,this.attributeLayout,o.glyphs[0].textureBinding),t.recordBounds(P,b,w,w),this._writeTextBox(t,e,i,r,o.textBox,a,c),t.recordEnd());for(const T of o.glyphs){t.recordStart(this.instanceId,this.attributeLayout,T.textureBinding),t.recordBounds(P,b,w,w);const{texcoords:R,offsets:V}=T;this._writeQuad(t,e,i,r,{texcoords:R,offsets:V,fontSize:f,color:g(l.color),isBackground:!1,referenceBounds:a,minZoom:x,maxZoom:m,...c}),t.recordEnd()}n!==0&&o.setRotation(-n)}_writeTextBox(t,e,i,r,o,n,a){const c=this.evaluatedMeshParams,{fontSize:l}=this._textMeshTransformProps,{boxBackgroundColor:u,boxBorderLineColor:f}=c,p={isBackground:!0,fontSize:l,referenceBounds:n,...a};u&&(this._writeQuad(t,e,i,r,{texcoords:Ts,offsets:o.main,color:g(u),...p}),f||(this._writeQuad(t,e,i,r,{texcoords:Es,offsets:o.top,color:g(u),...p}),this._writeQuad(t,e,i,r,{texcoords:Ms,offsets:o.bot,color:g(u),...p}),this._writeQuad(t,e,i,r,{texcoords:$s,offsets:o.left,color:g(u),...p}),this._writeQuad(t,e,i,r,{texcoords:Is,offsets:o.right,color:g(u),...p}))),f&&(this._writeQuad(t,e,i,r,{texcoords:$t,offsets:o.top,color:g(f),...p}),this._writeQuad(t,e,i,r,{texcoords:$t,offsets:o.bot,color:g(f),...p}),this._writeQuad(t,e,i,r,{texcoords:It,offsets:o.left,color:g(f),...p}),this._writeQuad(t,e,i,r,{texcoords:It,offsets:o.right,color:g(f),...p}))}_writeQuad(t,e,i,r,o){const n=t.vertexCount();this._writeVertex(t,e,i,r,o),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}}const zs=s=>Math.round(s*(254/360)),Ns={createComputedParams:s=>s,optionalAttributes:A.optionalAttributes,attributes:{...A.attributes,bitset:{type:h.UNSIGNED_BYTE,count:1,pack:({shouldSampleAlphaOnly:s,shouldScaleDash:t,isSDF:e})=>H([[At,s],[ye,t],[_e,e]])},tlbr:{type:h.UNSIGNED_SHORT,count:4,pack:({sprite:s})=>{const{rect:t,width:e,height:i}=s,r=t.x+N,o=t.y+N;return[r,o,r+e,o+i]}},accumulatedDistance:{type:h.UNSIGNED_SHORT,count:1,packTessellation:({distance:s})=>s},segmentDirection:{type:h.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:s,directionY:t})=>[s,t]}}};class oi extends qt{constructor(t,e,i,r){super(t,e,i,r),this.vertexSpec=Ns,this._tessellationOptions.textured=!0}_write(t,e,i){const r=i??v.fromFeatureSetReaderCIM(e);if(!r)return;const{sprite:o}=this.evaluatedMeshParams;this._writeGeometry(t,e,r,o?.textureBinding)}}class it{static from(t){return"width"in t?this.fromSimpleMeshParams(t):this.fromComplexMeshParams(t)}static fromSimpleMeshParams(t){const e=new it(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects),{type:i,width:r,height:o,angle:n,alignment:a,outlineSize:c,referenceSize:l,sprite:u,overrideOutlineColor:f}=t;e.rawWidth=y(r),e.rawHeight=y(o),e.angle=n,e.alignment=a,e.outlineSize=y(c),e.referenceSize=y(l),e.overrideOutlineColor=f,e.offsetX=y(t.offsetX),e.offsetY=y(t.offsetY),i!=="simple"||u.sdf||(e.rawWidth=u.width,e.rawHeight=u.height);const p=2;return e.sizeRatio=u.sdf?p:1,e._computeSize(t,!1),e}static fromComplexMeshParams(t){const e=new it(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects);let{alignment:i,transforms:r,size:o,scaleX:n,anchorX:a,anchorY:c,angle:l,colorLocked:u,frameHeight:f,widthRatio:p,offsetX:d,offsetY:x,outlineSize:m,referenceSize:_,scaleFactor:P,sizeRatio:b,isAbsoluteAnchorPoint:Y,rotateClockwise:w,scaleSymbolsProportionally:T,sprite:R}=t;if(r&&r.infos.length>0){const X=Yt(o,l,w,d,x,r);o=X.size,l=X.rotation,d=X.offsetX,x=X.offsetY,w=!1}P&&(o*=P,d*=P,x*=P);const V=n*(R.width/R.height);e.alignment=i,e.rawHeight=y(o),e.rawWidth=e.rawHeight*V,e.referenceSize=y(_),e.sizeRatio=b,e.angle=l,e.rotateClockwise=w,e.anchorX=a,e.anchorY=c,e.offsetX=y(d),e.offsetY=y(x),Y&&o&&(R.sdf?e.anchorX=a/(o*p):e.anchorX=a/(o*V),e.anchorY=c/o);const Kt=T&&f?o/f:1;return e.outlineSize=m===0||isNaN(m)?0:y(m)*Kt,e.scaleSymbolsProportionally=T,e.colorLocked=u,e._computeSize(t,!0),e}constructor(t,e,i,r,o,n,a){this.sprite=t,this.color=e,this.outlineColor=i,this.minPixelBuffer=r,this.placement=o,this.scaleInfo=n,this.effects=a,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.alignment=Rt.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(t,e){const{sprite:i,hasSizeVV:r}=t,o=!!i.sdf,{rawWidth:n,rawHeight:a,sizeRatio:c,outlineSize:l}=this,u=n*c,f=a*c;if(o&&!r){const Y=e&&n>a?u:n,w=a,T=l+2*1;this.computedWidth=Math.min(Y+T,u),this.computedHeight=Math.min(w+T,f)}else this.computedWidth=u,this.computedHeight=f;const p=o?Math.max(i.width,i.height)/Math.max(u,f):1,d=.5*(u-this.computedWidth)*p,x=.5*(f-this.computedHeight)*p,m=i.rect.x+N+d,_=i.rect.y+N+x,P=m+i.width-2*d,b=_+i.height-2*x;this.texXmin=Math.floor(m),this.texYmin=Math.floor(_),this.texXmax=Math.ceil(P),this.texYmax=Math.ceil(b),this.computedWidth*=(this.texXmax-this.texXmin)/(P-m),this.computedHeight*=(this.texYmax-this.texYmin)/(b-_),this.anchorX*=u/this.computedWidth,this.anchorY*=f/this.computedHeight}}const Bs=3.14159265359/180,Ds=128/Math.PI;function Ys(s,t){return s%=t,Math.abs(s>=0?s:s+t)}function Rs(s){return Ys(s*Ds,256)}function Fs(s,t,e,i,r=!1){const o=ne(),n=r?1:-1;return ae(o),(t||e)&&ce(o,o,[t,-e]),i&&ue(o,o,n*Bs*-i),o}const Gs={createComputedParams:s=>it.from(s),optionalAttributes:{zoomRange:{type:h.SHORT,count:2,packPrecisionFactor:rt,pack:({scaleInfo:s},{tileInfo:t})=>U(s,t)}},attributes:{pos:{type:h.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:h.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:h.UNSIGNED_BYTE,count:1,pack:({sprite:s,alignment:t,scaleSymbolsProportionally:e,overrideOutlineColor:i,colorLocked:r})=>{let o=0;return s.sdf&&(o|=G(F.bitset.isSDF)),t===Rt.MAP&&(o|=G(F.bitset.isMapAligned)),e&&(o|=G(F.bitset.scaleSymbolsProportionally)),i&&(o|=G(F.bitset.overrideOutlineColor)),r&&(o|=G(F.bitset.colorLocked)),o}},offset:{type:h.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({angle:s,computedWidth:t,computedHeight:e,anchorX:i,anchorY:r,offsetX:o,offsetY:n,rotateClockwise:a})=>{const c=Fs(0,o,n,-s,a),l=-(.5+i)*t,u=-(.5-r)*e,f=[l,u],p=[l+t,u],d=[l,u+e],x=[l+t,u+e];return Z(f,f,c),Z(p,p,c),Z(d,d,c),Z(x,x,c),[f,p,d,x]}}},textureUV:{type:h.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({texXmax:s,texXmin:t,texYmax:e,texYmin:i})=>[[t,i],[s,i],[t,e],[s,e]]}},color:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:s})=>g(s)},outlineColor:{type:h.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:s})=>g(s)},sizing:{type:h.UNSIGNED_BYTE,count:4,pack:({rawWidth:s,rawHeight:t,outlineSize:e,referenceSize:i})=>{const r=Math.max(s,t);return[ut(r,128),ut(e,128),ut(i,128),0]}},placementAngle:{type:h.UNSIGNED_BYTE,count:1,packTessellation:({placementAngle:s})=>Rs(s)},sizeRatio:{type:h.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:({sizeRatio:s})=>s}}};class ni extends D{constructor(){super(...arguments),this.vertexSpec=Gs}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(t,e,i){const r=this.evaluatedMeshParams.sprite?.textureBinding,o=e.getDisplayId();t.recordStart(this.instanceId,this.attributeLayout,r);const n=this.evaluatedMeshParams.minPixelBuffer,a=Math.max(this.evaluatedMeshParams.computedWidth,n),c=Math.max(this.evaluatedMeshParams.computedHeight,n),l=this.evaluatedMeshParams.offsetX,u=-this.evaluatedMeshParams.offsetY;if(this.evaluatedMeshParams.placement!=null)this._writePlacedMarkers(t,e,i,a,c);else if(i?.nextPath()){i.nextPoint();const f=i.x,p=i.y;t.recordBounds(f+l,p+u,a,c),this._writeQuad(t,o,f,p)}else if(e.geometryType==="esriGeometryPolygon"){const f=e.readCentroidForDisplay();if(!f)return;const[p,d]=f.coords;t.recordBounds(p+l,d+u,a,c),this._writeQuad(t,o,p,d)}else if(e.geometryType==="esriGeometryPoint"){const f=e.readXForDisplay(),p=e.readYForDisplay();t.recordBounds(f+l,p+u,a,c),this._writeQuad(t,o,f,p)}else e.readGeometryForDisplay()?.forEachVertex((p,d)=>{t.recordBounds(p+l,d+u,a,c),Math.abs(p)>q||Math.abs(d)>q||this._writeQuad(t,o,p,d)});t.recordEnd()}_writePlacedMarkers(t,e,i,r,o){const n=i??v.fromFeatureSetReaderCIM(e)?.clone();if(!n)return;const a=-1,c=Jt.getPlacement(n,a,this.evaluatedMeshParams.placement,y(1),t.id,xt());if(!c)return;const l=e.getDisplayId();let u=c.next();const f=this.evaluatedMeshParams.offsetX,p=-this.evaluatedMeshParams.offsetY;for(;u!=null;){const d=u.tx,x=-u.ty;if(Math.abs(d)>q||Math.abs(x)>q){u=c.next();continue}const m=-u.getAngle();t.recordBounds(d+f,x+p,r,o),this._writeQuad(t,l,d,x,m),u=c.next()}}_writeQuad(t,e,i,r,o){const n=t.vertexCount(),a=o==null?null:{placementAngle:o};this._writeVertex(t,e,i,r,a),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}}const Ls={createComputedParams:s=>s,optionalAttributes:{},attributes:{pos:{type:h.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:h.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:h.UNSIGNED_BYTE,count:1,pack:s=>0},offset:{type:h.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:({size:s})=>{const t=y(s),e=-t/2,i=-t/2;return[[e,i],[e+t,i],[e,i+t],[e+t,i+t]]}}},texCoords:{type:h.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:h.UNSIGNED_BYTE,count:2,pack:({size:s})=>[s,s]},referenceSize:{type:h.UNSIGNED_BYTE,count:1,pack:({size:s})=>y(s)},zoomRange:{type:h.UNSIGNED_BYTE,count:2,pack:({scaleInfo:s},{tileInfo:t})=>U(s,t)}}};class ai extends D{constructor(){super(...arguments),this.vertexSpec=Ls}_write(t,e){const i=e.getDisplayId(),r=this.evaluatedMeshParams.minPixelBuffer,o=Math.max(y(this.evaluatedMeshParams.size),r);let n,a;if(e.geometryType==="esriGeometryPoint")n=e.readXForDisplay(),a=e.readYForDisplay();else{const l=e.readCentroidForDisplay();if(!l)return;n=l?.coords[0],a=l?.coords[1]}t.recordStart(this.instanceId,this.attributeLayout),t.recordBounds(n,a,o,o);const c=t.vertexCount();this._writeVertex(t,i,n,a),t.indexWrite(c+0),t.indexWrite(c+1),t.indexWrite(c+2),t.indexWrite(c+1),t.indexWrite(c+3),t.indexWrite(c+2),t.recordEnd()}}export{ri as N,vs as S,qt as T,ei as _,oi as a,ti as b,si as c,Ks as d,Vt as e,g,jt as h,ii as i,es as l,U as m,fs as o,ai as s,ni as v};
